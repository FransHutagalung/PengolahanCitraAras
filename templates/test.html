<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengolahan Citra Digital Beraras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-explanation {
            border: 2px solid black;
        }

        .image-container {
            margin: 20px 0;
            border: 1px solid #ddd;
            padding: 10px;
            background: #f8f9fa;
        }

        .image-preview {
            max-width: 100%;
            height: auto;
        }

        .processing-section {
            margin: 30px 0;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .explanation {
            width: 100%;
            text-align: justify;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            white-space: pre-wrap;
        }

        .modal-body .form-range {
            width: 100%;
            display: block;
        }

        .range-value-display {
            display: inline-block;
            width: 60px;
            text-align: center;
            font-weight: bold;
            margin-left: 10px;
        }

        .modal-body .form-text {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .modal-body input[type="number"] {
            width: 100px;
        }

        .parameter-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .parameter-label {
            width: 30%;
            font-weight: 500;
        }

        .parameter-input {
            width: 70%;
        }

        .processing-type {
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 8px;
            padding: 8px;
            transition: background-color 0.3s;
        }

        .processing-type:hover {
            background-color: #e9ecef;
        }

        .result-card {
            transition: transform 0.3s;
        }

        .result-card:hover {
            transform: scale(1.02);
        }

        .image-comparison {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .image-column {
            flex: 1;
            text-align: center;
        }

        .param-badge {
            background-color: #e9ecef;
            padding: 3px 8px;
            border-radius: 10px;
            display: inline-block;
            margin: 2px;
            font-size: 0.85em;
        }
    </style>
</head>

<body>
    <div class="container py-5">
        <h1 class="text-center mb-4">PENGOLAHAN CITRA DIGITAL</h1>
        <p class="text-center mb-5">Aplikasi pengolahan citra dengan berbagai metode pada level titik, lokal, global,
            dan objek</p>

        <!-- Upload Section -->
        <div class="processing-section">
            <h2>Upload Gambar</h2>
            <div class="row">
                <div class="col-md-6">
                    <input type="file" id="fileInput" class="form-control" accept="image/*">
                    <small class="text-muted">Format yang didukung: JPG, PNG, BMP, GIF</small>
                </div>
                <div class="col-md-6">
                    <div id="uploadStatus" class="alert alert-info">Belum ada gambar diunggah</div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col">
                    <div id="originalImage" class="image-container text-center">
                        <!-- Original image will be displayed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Processing Controls -->
        <div class="processing-section">
            <h2>Pilih Jenis Pengolahan</h2>

            <ul class="nav nav-tabs mb-4" id="processingTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="titik-tab" data-bs-toggle="tab" data-bs-target="#titik"
                        type="button" role="tab" aria-controls="titik" aria-selected="true">Aras Titik</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="lokal-tab" data-bs-toggle="tab" data-bs-target="#lokal" type="button"
                        role="tab" aria-controls="lokal" aria-selected="false">Aras Lokal</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="global-tab" data-bs-toggle="tab" data-bs-target="#global" type="button"
                        role="tab" aria-controls="global" aria-selected="false">Aras Global</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="objek-tab" data-bs-toggle="tab" data-bs-target="#objek" type="button"
                        role="tab" aria-controls="objek" aria-selected="false">Aras Objek</button>
                </li>
            </ul>

            <div class="tab-content" id="processingTabContent">
                <!-- Aras Titik -->
                <div class="tab-pane fade show active" id="titik" role="tabpanel" aria-labelledby="titik-tab">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('titik', 'brightness')">
                                <h5>Brightness</h5>
                                <p class="small mb-0">Mengubah tingkat kecerahan pada seluruh piksel citra</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('titik', 'contrast')">
                                <h5>Contrast</h5>
                                <p class="small mb-0">Mengubah rentang intensitas piksel pada citra</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('titik', 'threshold')">
                                <h5>Threshold</h5>
                                <p class="small mb-0">Konversi ke citra biner dengan nilai ambang batas</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('titik', 'negative')">
                                <h5>Negative</h5>
                                <p class="small mb-0">Menghasilkan kebalikan dari warna asli</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('titik', 'hist_eq')">
                                <h5>Histogram Equalization</h5>
                                <p class="small mb-0">Meningkatkan kontras dengan pemerataan histogram</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('titik', 'gamma')">
                                <h5>Gamma Correction</h5>
                                <p class="small mb-0">Penyesuaian non-linear pada tingkat kecerahan</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('titik', 'log')">
                                <h5>Log Transformation</h5>
                                <p class="small mb-0">Menekan nilai piksel tinggi dan memperluas nilai rendah</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aras Lokal -->
                <div class="tab-pane fade" id="lokal" role="tabpanel" aria-labelledby="lokal-tab">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('lokal', 'gaussian_blur')">
                                <h5>Gaussian Blur</h5>
                                <p class="small mb-0">Menghaluskan citra dengan filter Gaussian</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('lokal', 'median_filter')">
                                <h5>Median Filter</h5>
                                <p class="small mb-0">Mengurangi noise dengan filter median</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('lokal', 'sharpening')">
                                <h5>Sharpening</h5>
                                <p class="small mb-0">Mempertajam detail pada citra</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('lokal', 'gradient')">
                                <h5>Gradient (Edge)</h5>
                                <p class="small mb-0">Deteksi tepi dengan metode gradien</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('lokal', 'adaptive_threshold')">
                                <h5>Adaptive Threshold</h5>
                                <p class="small mb-0">Nilai ambang batas adaptif berdasarkan area lokal</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('lokal', 'bilateral')">
                                <h5>Bilateral Filter</h5>
                                <p class="small mb-0">Filter yang mempertahankan tepi sambil menghaluskan</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('lokal', 'sobel')">
                                <h5>Sobel Filter</h5>
                                <p class="small mb-0">Deteksi tepi dengan operator Sobel</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aras Global -->
                <div class="tab-pane fade" id="global" role="tabpanel" aria-labelledby="global-tab">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('global', 'fourier')">
                                <h5>Fourier Transform</h5>
                                <p class="small mb-0">Transformasi dari domain spasial ke domain frekuensi</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('global', 'lowpass')">
                                <h5>Low Pass Filter</h5>
                                <p class="small mb-0">Menekan frekuensi tinggi (detail) pada citra</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('global', 'highpass')">
                                <h5>High Pass Filter</h5>
                                <p class="small mb-0">Menekan frekuensi rendah pada citra</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="processing-type"
                                onclick="document.getElementById('histogramMatchFile').click()">
                                <h5>Histogram Matching</h5>
                                <p class="small mb-0">Menyesuaikan histogram ke citra referensi</p>
                                <input type="file" id="histogramMatchFile" class="d-none" accept="image/*">
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('global', 'bandpass')">
                                <h5>Band Pass Filter</h5>
                                <p class="small mb-0">Mempertahankan frekuensi dalam rentang tertentu</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aras Objek -->
                <div class="tab-pane fade" id="objek" role="tabpanel" aria-labelledby="objek-tab">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('objek', 'kmeans')">
                                <h5>K-Means Clustering</h5>
                                <p class="small mb-0">Segmentasi citra dengan algoritma K-Means</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('objek', 'components')">
                                <h5>Connected Components</h5>
                                <p class="small mb-0">Identifikasi objek terkoneksi pada citra</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('objek', 'watershed')">
                                <h5>Watershed</h5>
                                <p class="small mb-0">Segmentasi citra dengan algoritma Watershed</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('objek', 'contour')">
                                <h5>Contour Detection</h5>
                                <p class="small mb-0">Ekstraksi kontur objek pada citra</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('objek', 'hough')">
                                <h5>Hough Transform</h5>
                                <p class="small mb-0">Deteksi garis atau bentuk dengan transformasi Hough</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="processing-type" onclick="process('objek', 'texture')">
                                <h5>Texture Analysis</h5>
                                <p class="small mb-0">Analisis tekstur pada citra</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="processing-section">
            <h2>Hasil Pengolahan</h2>
            <div id="resultsContainer" class="row">
                <!-- Results will be added here dynamically -->
            </div>
        </div>

        <!-- Demo Section -->
        <div class="processing-section">
            <h2>Demo Semua Aras</h2>
            <p>Jalankan demo untuk melihat contoh hasil dari semua metode pengolahan citra</p>
            <button class="btn btn-primary" onclick="runFullDemo()">Jalankan Demo Lengkap</button>
            <div id="demoResults" class="row mt-4"></div>
        </div>
    </div>

    <!-- Parameter Modal -->
    <div class="modal fade" id="parameterModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Parameter Pengolahan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="processingDescription" class="alert alert-info mb-4"></div>
                    <form id="parameterForm">
                        <!-- Dynamic content will be inserted here -->
                    </form>

                    <!-- Preview section -->
                    <div class="mt-4 mb-2">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="livePreviewToggle" checked>
                            <label class="form-check-label" for="livePreviewToggle">Live Preview</label>
                        </div>
                    </div>
                    <div id="previewSection" class="row align-items-center">
                        <div class="col-md-5">
                            <div id="previewOriginal" class="text-center">
                                <!-- Original image for comparison -->
                            </div>
                            <p class="text-center mt-2">Gambar Asli</p>
                        </div>
                        <div class="col-md-2 text-center">
                            <i class="bi bi-arrow-right fs-1"></i>
                        </div>
                        <div class="col-md-5">
                            <div id="previewProcessed" class="text-center">
                                <!-- Processed image preview -->
                            </div>
                            <p class="text-center mt-2">Hasil Preview</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="submitParameters()">Terapkan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentProcessing = { jenis: null, teknik: null };
        let originalImageData = null;
        let livePreviewTimeout = null;

        // Deskripsi teknik pengolahan
        const processingDescriptions = {
            'titik': {
                'brightness': 'Mengubah tingkat kecerahan (brightness) pada seluruh piksel citra. Nilai positif akan mencerahkan gambar, sedangkan nilai negatif akan menggelapkan gambar.',
                'contrast': 'Mengubah rentang intensitas piksel pada citra untuk meningkatkan atau mengurangi kontras. Nilai >1 meningkatkan kontras, nilai <1 mengurangi kontras.',
                'threshold': 'Mengkonversi citra menjadi hitam-putih (biner) dengan nilai ambang batas tertentu. Piksel dengan nilai di atas threshold akan menjadi putih, di bawah akan menjadi hitam.',
                'negative': 'Menghasilkan citra negatif dengan membalik nilai piksel (255 - nilai piksel). Tidak memerlukan parameter tambahan.',
                'hist_eq': 'Meningkatkan kontras dengan pemerataan histogram. Meratakan distribusi intensitas piksel. Tidak memerlukan parameter tambahan.',
                'gamma': 'Melakukan koreksi gamma yang merupakan transformasi non-linear pada tingkat kecerahan. Berguna untuk menyesuaikan citra pada perangkat yang berbeda.',
                'log': 'Transformasi logaritmik untuk menekan nilai piksel tinggi dan memperluas nilai piksel rendah. Berguna untuk meningkatkan detail pada area gelap.'
            },
            'lokal': {
                'gaussian_blur': 'Menghaluskan citra dengan filter Gaussian. Semakin besar nilai sigma, semakin besar efek blur yang dihasilkan.',
                'median_filter': 'Mengurangi noise dengan mengganti nilai piksel dengan nilai median dari piksel tetangganya. Efektif untuk menghilangkan noise "salt and pepper".',
                'sharpening': 'Mempertajam detail pada citra dengan menekankan perbedaan dengan piksel tetangga. Parameter alpha mengontrol kekuatan efek penajaman.',
                'gradient': 'Deteksi tepi dengan metode gradien yang menghitung perbedaan intensitas antar piksel tetangga.',
                'adaptive_threshold': 'Nilai ambang batas adaptif yang ditentukan berdasarkan statistik dari area lokal sekitar piksel. Berguna untuk citra dengan pencahayaan tidak merata.',
                'bilateral': 'Filter yang mempertahankan tepi sambil menghaluskan area homogen. Mempertimbangkan jarak spasial dan perbedaan intensitas.',
                'sobel': 'Deteksi tepi dengan operator Sobel yang menghitung gradien citra untuk menemukan perubahan intensitas.'
            },
            'global': {
                'fourier': 'Transformasi dari domain spasial ke domain frekuensi menggunakan Discrete Fourier Transform. Memungkinkan analisis citra dalam domain frekuensi.',
                'lowpass': 'Menekan frekuensi tinggi (detail) pada citra dengan radius cutoff yang dapat disesuaikan. Menghasilkan efek penghalusan.',
                'highpass': 'Menekan frekuensi rendah pada citra, menyisakan detail dan tepi. Menghasilkan efek penajaman.',
                'bandpass': 'Mempertahankan frekuensi dalam rentang tertentu, menekan frekuensi di luar rentang tersebut.'
            },
            'objek': {
                'kmeans': 'Segmentasi citra dengan algoritma K-Means yang mengelompokkan piksel berdasarkan kemiripan warna/intensitasnya.',
                'components': 'Identifikasi objek terkoneksi (connected components) pada citra. Berguna untuk menghitung jumlah objek.',
                'watershed': 'Segmentasi citra dengan algoritma Watershed yang menganggap citra sebagai relief topografi.',
                'contour': 'Ekstraksi kontur atau batas dari objek pada citra.',
                'hough': 'Deteksi garis atau bentuk geometris lainnya dengan transformasi Hough.',
                'texture': 'Analisis tekstur pada citra untuk mengidentifikasi area dengan pola tertentu.'
            }
        };

        // Handle file upload
        document.getElementById('fileInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            // Show loading indicator
            document.getElementById('uploadStatus').innerHTML = `
                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                <span class="ms-2">Mengunggah gambar...</span>
            `;

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        originalImageData = data.gambar;
                        document.getElementById('uploadStatus').innerHTML = `
                        <div class="alert alert-success mb-0">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <strong>Gambar berhasil diunggah!</strong>
                            <div class="mt-2">
                                <span class="param-badge">Resolusi: ${data.ukuran[1]}x${data.ukuran[0]} piksel</span>
                                <span class="param-badge">Ukuran: ${(file.size / 1024).toFixed(2)} KB</span>
                            </div>
                        </div>
                    `;
                        document.getElementById('originalImage').innerHTML = `
                        <img src="data:image/png;base64,${data.gambar}" class="image-preview">
                    `;
                    } else {
                        document.getElementById('uploadStatus').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>Error:</strong> ${data.error}
                        </div>
                    `;
                    }
                })
                .catch(error => {
                    document.getElementById('uploadStatus').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>Error:</strong> Gagal mengunggah gambar
                    </div>
                `;
                    console.error('Error:', error);
                });
        });

        // Handle processing requests
        function process(jenis, teknik) {
            // Check if image is uploaded
            if (!originalImageData) {
                showAlert('warning', 'Silakan unggah gambar terlebih dahulu!');
                return;
            }

            currentProcessing = { jenis, teknik };

            // Show description in modal
            const description = processingDescriptions[jenis][teknik] || 'Tidak ada deskripsi tersedia.';
            document.getElementById('processingDescription').innerHTML = `
                <strong>${getTeknikTitle(teknik)}</strong><br>
                ${description}
            `;

            // Set up preview section
            document.getElementById('previewOriginal').innerHTML = `
                <img src="data:image/png;base64,${originalImageData}" class="img-fluid">
            `;
            document.getElementById('previewProcessed').innerHTML = `
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Memproses preview...</p>
                </div>
            `;

            // Show parameter modal if needed
            const params = getParametersForTechnique(jenis, teknik);
            if (params.length > 0) {
                showParameterModal(params);
                // Request initial preview
                if (document.getElementById('livePreviewToggle').checked) {
                    requestLivePreview();
                }
            } else {
                sendProcessingRequest({});
            }
        }

        function getTeknikTitle(teknik) {
            // Convert snake_case to Title Case
            return teknik.split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        function getParametersForTechnique(jenis, teknik) {
            const parameters = {
                'titik': {
                    'brightness': [
                        {
                            name: 'nilai',
                            label: 'Nilai Brightness',
                            type: 'range',
                            min: -255,
                            max: 255,
                            value: 0,
                            step: 1,
                            desc: 'Nilai positif untuk mencerahkan, nilai negatif untuk menggelapkan'
                        }
                    ],
                    'contrast': [
                        {
                            name: 'alpha',
                            label: 'Faktor Kontras',
                            type: 'range',
                            min: 0.1,
                            max: 3,
                            step: 0.1,
                            value: 1.0,
                            desc: 'Nilai >1 meningkatkan kontras, nilai <1 mengurangi kontras'
                        }
                    ],
                    'threshold': [
                        {
                            name: 'nilai',
                            label: 'Nilai Threshold',
                            type: 'range',
                            min: 0,
                            max: 255,
                            value: 127,
                            desc: 'Nilai ambang batas untuk konversi ke hitam-putih'
                        }
                    ],
                    'gamma': [
                        {
                            name: 'gamma',
                            label: 'Nilai Gamma',
                            type: 'range',
                            min: 0.1,
                            max: 5,
                            step: 0.1,
                            value: 1.0,
                            desc: 'Nilai <1 mencerahkan area gelap, nilai >1 menggelapkan area terang'
                        }
                    ],
                    'log': [
                        {
                            name: 'constant',
                            label: 'Nilai Konstanta',
                            type: 'range',
                            min: 1,
                            max: 50,
                            step: 1,
                            value: 20,
                            desc: 'Konstanta pengali untuk transformasi logaritmik'
                        }
                    ]
                },
                'lokal': {
                    'gaussian_blur': [
                        {
                            name: 'sigma',
                            label: 'Sigma (Intensitas Blur)',
                            type: 'range',
                            min: 0.1,
                            max: 10,
                            step: 0.1,
                            value: 1.5,
                            desc: 'Mengontrol seberapa kuat efek blur diterapkan'
                        },
                        {
                            name: 'kernel_size',
                            label: 'Ukuran Kernel',
                            type: 'select',
                            options: [
                                { value: 3, label: '3×3' },
                                { value: 5, label: '5×5' },
                                { value: 7, label: '7×7' },
                                { value: 9, label: '9×9' }
                            ],
                            value: 5,
                            desc: 'Ukuran filter Gaussian yang digunakan'
                        }
                    ],
                    'median_filter': [
                        {
                            name: 'kernel_size',
                            label: 'Ukuran Kernel',
                            type: 'select',
                            options: [
                                { value: 3, label: '3×3' },
                                { value: 5, label: '5×5' },
                                { value: 7, label: '7×7' },
                                { value: 9, label: '9×9' }
                            ],
                            value: 3,
                            desc: 'Ukuran window untuk filter median. Lebih besar = lebih halus'
                        }
                    ],
                    'sharpening': [
                        {
                            name: 'alpha',
                            label: 'Faktor Penajaman',
                            type: 'range',
                            min: 0.1,
                            max: 5,
                            step: 0.1,
                            value: 1.5,
                            desc: 'Intensitas efek penajaman yang diterapkan'
                        },
                        {
                            name: 'kernel_type',
                            label: 'Tipe Kernel',
                            type: 'select',
                            options: [
                                { value: 'laplacian', label: 'Laplacian' },
                                { value: 'unsharp', label: 'Unsharp Masking' }
                            ],
                            value: 'laplacian',
                            desc: 'Metode yang digunakan untuk penajaman'
                        }
                    ],
                    'gradient': [
                        {
                            name: 'operator',
                            label: 'Operator Gradien',
                            type: 'select',
                            options: [
                                { value: 'sobel', label: 'Sobel' },
                                { value: 'prewitt', label: 'Prewitt' },
                                { value: 'scharr', label: 'Scharr' }
                            ],
                            value: 'sobel',
                            desc: 'Operator untuk menghitung gradien'
                        },
                        {
                            name: 'threshold',
                            label: 'Nilai Threshold',
                            type: 'range',
                            min: 0,
                            max: 255,
                            value: 100,
                            desc: 'Ambang batas untuk hasil gradien'
                        }
                    ],
                    'adaptive_threshold': [
                        {
                            name: 'block_size',
                            label: 'Ukuran Blok',
                            type: 'range',
                            min: 3,
                            max: 99,
                            step: 2,
                            value: 11,
                            desc: 'Ukuran area lokal untuk menghitung threshold (harus bilangan ganjil)'
                        },
                        {
                            name: 'offset',
                            label: 'Offset',
                            type: 'range',
                            min: -20,
                            max: 20,
                            value: 2,
                            desc: 'Nilai yang dikurangkan dari rata-rata atau tertimbang'
                        },
                        {
                            name: 'method',
                            label: 'Metode',
                            type: 'select',
                            options: [
                                { value: 'mean', label: 'Mean' },
                                { value: 'gaussian', label: 'Gaussian' }
                            ],
                            value: 'gaussian',
                            desc: 'Metode untuk menghitung nilai threshold'
                        }
                    ],
                    'bilateral': [
                        {
                            name: 'diameter',
                            label: 'Diameter',
                            type: 'range',
                            min: 1,
                            max: 15,
                            value: 9,
                            desc: 'Diameter piksel tetangga yang dipertimbangkan'
                        },
                        {
                            name: 'sigma_color',
                            label: 'Sigma Color',
                            type: 'range',
                            min: 1,
                            max: 150,
                            value: 75,
                            desc: 'Filter pada domain warna/intensitas'
                        },
                        {
                            name: 'sigma_space',
                            label: 'Sigma Space',
                            type: 'range',
                            min: 1,
                            max: 150,
                            value: 75,
                            desc: 'Filter pada domain spasial/koordinat'
                        }
                    ],
                    'sobel': [
                        {
                            name: 'ksize',
                            label: 'Ukuran Kernel',
                            type: 'select',
                            options: [
                                { value: 1, label: '1×1' },
                                { value: 3, label: '3×3' },
                                { value: 5, label: '5×5' },
                                { value: 7, label: '7×7' }
                            ],
                            value: 3,
                            desc: 'Ukuran kernel operator Sobel'
                        },
                        {
                            name: 'direction',
                            label: 'Arah',
                            type: 'select',
                            options: [
                                { value: 'xy', label: 'Kedua Arah (Magnitudo)' },
                                { value: 'x', label: 'Horizontal (X)' },
                                { value: 'y', label: 'Vertikal (Y)' }
                            ],
                            value: 'xy',
                            desc: 'Arah deteksi tepi'
                        }
                    ],
                    'sobel': [
                        {
                            name: 'ksize',
                            label: 'Kernel Size',
                            type: 'select',
                            options: [
                                { value: 1, label: '1×1' },
                                { value: 3, label: '3×3' },
                                { value: 5, label: '5×5' },
                                { value: 7, label: '7×7' }
                            ],
                            value: 3,
                            desc: 'Ukuran kernel operator Sobel'
                        },
                        {
                            name: 'direction',
                            label: 'Direction',
                            type: 'select',
                            options: [
                                { value: 'xy', label: 'Both Directions' },
                                { value: 'x', label: 'Horizontal' },
                                { value: 'y', label: 'Vertical' }
                            ],
                            value: 'xy',
                            desc: 'Edge detection direction'
                        }
                    ]
                },
                'global': {
                    'lowpass': [
                        {
                            name: 'radius',
                            label: 'Cutoff Radius',
                            type: 'range',
                            min: 10,
                            max: 200,
                            value: 50,
                            desc: 'Radius for frequency cutoff'
                        }
                    ],
                    'highpass': [
                        {
                            name: 'radius',
                            label: 'Cutoff Radius',
                            type: 'range',
                            min: 10,
                            max: 200,
                            value: 50,
                            desc: 'Radius for frequency cutoff'
                        }
                    ]
                },
                'objek': {
                    'kmeans': [
                        {
                            name: 'clusters',
                            label: 'Number of Clusters',
                            type: 'number',
                            min: 2,
                            max: 10,
                            value: 3,
                            desc: 'Number of color clusters to create'
                        }
                    ]
                }
            };
            return parameters[jenis]?.[teknik] || [];
        }

        function showParameterModal(params) {
            const form = document.getElementById('parameterForm');
            form.innerHTML = '';

            params.forEach(param => {
                const div = document.createElement('div');
                div.className = 'parameter-row mb-3';

                const label = document.createElement('div');
                label.className = 'parameter-label';
                label.innerHTML = `${param.label}:`;

                const inputGroup = document.createElement('div');
                inputGroup.className = 'parameter-input';

                if (param.type === 'select') {
                    const select = document.createElement('select');
                    select.className = 'form-select';
                    select.name = param.name;
                    param.options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.label;
                        if (option.value === param.value) opt.selected = true;
                        select.appendChild(opt);
                    });
                    inputGroup.appendChild(select);
                } else {
                    const input = document.createElement('input');
                    input.className = param.type === 'range' ? 'form-range' : 'form-control';
                    input.type = param.type;
                    input.name = param.name;
                    input.min = param.min;
                    input.max = param.max;
                    input.step = param.step || 1;
                    input.value = param.value;

                    if (param.type === 'range') {
                        const valueDisplay = document.createElement('span');
                        valueDisplay.className = 'range-value-display';
                        valueDisplay.textContent = param.value;

                        input.addEventListener('input', e => {
                            valueDisplay.textContent = e.target.value;
                            if (document.getElementById('livePreviewToggle').checked) {
                                clearTimeout(livePreviewTimeout);
                                livePreviewTimeout = setTimeout(requestLivePreview, 300);
                            }
                        });

                        inputGroup.appendChild(input);
                        inputGroup.appendChild(valueDisplay);
                    } else {
                        inputGroup.appendChild(input);
                    }
                }

                div.appendChild(label);
                div.appendChild(inputGroup);
                form.appendChild(div);

                if (param.desc) {
                    const desc = document.createElement('small');
                    desc.className = 'form-text text-muted';
                    desc.textContent = param.desc;
                    form.appendChild(desc);
                }
            });

            new bootstrap.Modal(document.getElementById('parameterModal')).show();
        }

        // Frontend: Optimasi request preview
        function requestLivePreview() {
            if (!document.getElementById('livePreviewToggle').checked) return;

            const params = collectParameters();

            fetch(`/preview/${currentProcessing.jenis}/${currentProcessing.teknik}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            })
                .then(handleResponse)
                .then(updatePreview)
                .catch(handleError);
        }

        function submitParameters() {
            const formData = new FormData(document.getElementById('parameterForm'));
            const params = {};
            formData.forEach((value, key) => params[key] = value);
            sendProcessingRequest(params);
        }

        function sendProcessingRequest(params) {
            fetch(`/proses/${currentProcessing.jenis}/${currentProcessing.teknik}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    gambar: originalImageData,
                    parameters: params
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addResultCard(data.gambar, data.penjelasan);
                        new bootstrap.Modal(document.getElementById('parameterModal')).hide();
                    } else {
                        showAlert('danger', `Error: ${data.error}`);
                    }
                });
        }

        function addResultCard(imageData, explanation) {
            const cardId = `result-${Date.now()}`;
            const cardHtml = `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card result-card" id="${cardId}">
                        <img src="data:image/png;base64,${imageData}" class="card-img-top">
                        <div class="card-body">
                            <h5 class="card-title">${getTeknikTitle(currentProcessing.teknik)}</h5>
                            <div class="explanation">${explanation}</div>
                            <button class="btn btn-sm btn-outline-danger mt-2" 
                                onclick="document.getElementById('${cardId}').remove()">
                                <i class="bi bi-trash"></i> Hapus
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('resultsContainer').insertAdjacentHTML('afterbegin', cardHtml);
        }

        function showAlert(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.prepend(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        // Initialize event listeners
        document.getElementById('livePreviewToggle').addEventListener('change', function () {
            if (this.checked && document.getElementById('parameterForm').elements.length > 0) {
                requestLivePreview();
            }
        });
    </script>
</body>

</html>